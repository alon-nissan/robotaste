# New Stack Guide — React + FastAPI for RoboTaste

This guide explains the new frontend/backend stack built alongside the existing Streamlit app. It covers how to run it, how it's structured, and key concepts for someone new to React, TypeScript, and FastAPI.

---

## Table of Contents

1. [Quick Start](#quick-start)
2. [Architecture Overview](#architecture-overview)
3. [Project Structure](#project-structure)
4. [Concept Glossary](#concept-glossary)
5. [How-To Recipes](#how-to-recipes)
6. [Troubleshooting](#troubleshooting)

---

## Quick Start

### Run an Experiment (Production Mode)

```bash
cd Software
python start_new_ui.py                # Builds frontend, serves on LAN
python start_new_ui.py --with-pump    # Also starts pump control service
```
- Serves everything on `http://0.0.0.0:8000` (API + React frontend, one port)
- Terminal shows the subject URL and QR code for the tablet
- See **[docs/MULTI_DEVICE_SETUP.md](MULTI_DEVICE_SETUP.md)** for full multi-device instructions

### Develop (Dev Mode)

You need **two terminals** (or use `python start_new_ui.py --dev` to start both):

#### Terminal 1 — FastAPI Backend (Python)
```bash
cd Software
uvicorn api.main:app --reload --port 8000 --ws none
```
- Runs on `http://localhost:8000`
- `--reload` = auto-restarts when you change Python files
- API docs at `http://localhost:8000/docs` (auto-generated by FastAPI)

#### Terminal 2 — React Frontend (Node.js)
```bash
cd Software/frontend
npm run dev
```
- Runs on `http://localhost:5173`
- Hot Module Replacement (HMR) = changes appear instantly without page reload
- `/api` requests are automatically proxied to FastAPI (port 8000)

### Existing Streamlit App (unchanged)
```bash
cd Software
streamlit run main_app.py
```
- Still runs on `http://localhost:8501`
- Both stacks share the same `robotaste.db` database

---

## Architecture Overview

```
Browser (localhost:5173)
    │
    ├── React App (TypeScript + Tailwind CSS)
    │   ├── ModeratorSetupPage    → Protocol selection, pump setup, start
    │   └── ModeratorMonitoringPage → Live monitoring, samples, pump status
    │
    ▼
FastAPI Server (localhost:8000)
    │
    ├── /api/protocols   → List/upload protocols
    ├── /api/sessions    → Create/start/monitor sessions
    ├── /api/pump        → Pump status and refill
    └── /api/docs        → Download documentation files
    │
    ▼
Existing Python Modules (robotaste/)
    │
    ▼
SQLite Database (robotaste.db)
```

**Key principle:** The FastAPI server is a thin wrapper around existing `robotaste/` modules. No business logic is duplicated — the same Python code handles both Streamlit and React requests.

---

## Project Structure

### Backend: `api/`
```
api/
├── __init__.py          # Package marker (empty)
├── main.py              # FastAPI app entry point, CORS config, startup
└── routers/
    ├── __init__.py
    ├── protocols.py     # Protocol CRUD endpoints
    ├── sessions.py      # Session lifecycle endpoints
    ├── pump.py          # Pump status and refill
    └── documentation.py # File download endpoints
```

### Frontend: `frontend/`
```
frontend/
├── package.json         # Dependencies and scripts (like requirements.txt)
├── tsconfig.json        # TypeScript configuration
├── vite.config.ts       # Vite build tool configuration
├── index.html           # Entry HTML file (loads main.tsx)
├── public/
│   └── niv_lab_logo.png # Static assets served as-is
└── src/
    ├── main.tsx         # Entry point: renders App into the page
    ├── App.tsx          # Root component with routing
    ├── index.css        # Tailwind CSS imports + brand colors
    ├── api/
    │   └── client.ts    # Axios HTTP client (base URL config)
    ├── types/
    │   └── index.ts     # TypeScript interfaces (data shapes)
    ├── components/      # Reusable UI building blocks
    │   ├── Logo.tsx
    │   ├── PageLayout.tsx
    │   ├── ProtocolSelector.tsx
    │   ├── ProtocolUpload.tsx
    │   ├── DocumentationLinks.tsx
    │   └── PumpSetup.tsx
    └── pages/           # Full page compositions
        ├── ModeratorSetupPage.tsx
        └── ModeratorMonitoringPage.tsx
```

---

## Concept Glossary

### React Concepts

| Concept | Explanation | Python Equivalent |
|---------|-------------|-------------------|
| **Component** | A function that returns UI (JSX). The building block of React apps. | A function that generates HTML |
| **JSX** | HTML-like syntax inside JavaScript. `<div className="x">text</div>` | f-string with HTML: `f'<div class="x">text</div>'` |
| **Props** | Parameters passed to a component from its parent. Read-only. | Function arguments |
| **State** (`useState`) | A value that can change, triggering a re-render. | `st.session_state` variable |
| **Effect** (`useEffect`) | Code that runs after render (e.g., API calls). | `@st.cache_data` or code in `if __name__` |
| **Hook** | Any function starting with `use`. Provides React features to components. | Decorator or context manager |
| **Re-render** | When state changes, React re-runs the component function and updates the DOM. | `st.rerun()` |
| **Callback** | A function passed as a prop, called by the child to notify the parent. | Callback function argument |

### TypeScript Concepts

| Concept | Explanation | Python Equivalent |
|---------|-------------|-------------------|
| **`interface`** | Defines the shape of an object (fields + types). | `TypedDict` or `dataclass` |
| **`string`** | Text type. | `str` |
| **`number`** | Numeric type (int or float). | `int` or `float` |
| **`boolean`** | True/false. | `bool` |
| **`?` (optional)** | Field may be undefined. `name?: string` | `Optional[str]` |
| **`Record<K, V>`** | Dictionary type. `Record<string, number>` | `Dict[str, float]` |
| **`T[]`** | Array of type T. `string[]` | `List[str]` |
| **Generic `<T>`** | Type parameter. `useState<string>("")` | Generic `List[str]` |

### FastAPI Concepts

| Concept | Explanation | Streamlit Equivalent |
|---------|-------------|---------------------|
| **`@app.get("/path")`** | Defines an HTTP GET endpoint. | N/A (Streamlit doesn't have routes) |
| **`@app.post("/path")`** | Defines an HTTP POST endpoint. | N/A |
| **`async def`** | Async function (FastAPI handles concurrency). | Regular `def` |
| **Pydantic model** | Data validation class (like TypedDict but with validation). | Manual `if/else` checks |
| **CORS** | Cross-Origin Resource Sharing — allows the React app to call the API. | N/A |

### Tailwind CSS Concepts

| Class | Meaning | CSS Equivalent |
|-------|---------|---------------|
| `p-6` | Padding: 24px (6 × 4px) | `padding: 24px` |
| `m-4` | Margin: 16px | `margin: 16px` |
| `text-lg` | Large text (18px) | `font-size: 18px` |
| `bg-primary` | Background color: our brand burgundy | `background-color: #521924` |
| `rounded-xl` | Large border radius | `border-radius: 12px` |
| `flex` | Flexbox layout | `display: flex` |
| `grid grid-cols-2` | 2-column grid | `display: grid; grid-template-columns: repeat(2, 1fr)` |
| `gap-6` | Gap between grid/flex items: 24px | `gap: 24px` |
| `hover:bg-gray-100` | Background color on mouse hover | `:hover { background: #f3f4f6 }` |

---

## How-To Recipes

### Add a New Page

1. **Create the page component** in `frontend/src/pages/`:
   ```tsx
   // src/pages/MyNewPage.tsx
   import PageLayout from '../components/PageLayout';
   
   export default function MyNewPage() {
     return (
       <PageLayout>
         <h1>My New Page</h1>
       </PageLayout>
     );
   }
   ```

2. **Add a route** in `src/App.tsx`:
   ```tsx
   import MyNewPage from './pages/MyNewPage';
   // Inside <Routes>:
   <Route path="/my-new-page" element={<MyNewPage />} />
   ```

3. Visit `http://localhost:5173/my-new-page`

### Add a New API Endpoint

1. **Create a router** in `api/routers/`:
   ```python
   # api/routers/my_endpoint.py
   from fastapi import APIRouter
   router = APIRouter(prefix="/api/my-endpoint", tags=["my-endpoint"])
   
   @router.get("")
   async def get_data():
       return {"message": "Hello from my endpoint"}
   ```

2. **Register it** in `api/main.py`:
   ```python
   from api.routers import my_endpoint
   app.include_router(my_endpoint.router)
   ```

3. **Call it from React**:
   ```tsx
   import { api } from '../api/client';
   const response = await api.get('/my-endpoint');
   ```

### Change Brand Colors

Edit `frontend/src/index.css`:
```css
@theme {
  --color-primary: #521924;    /* Change this hex value */
  --color-accent: #fda50f;     /* Change this hex value */
}
```

All components using `bg-primary`, `text-accent`, etc. will update automatically.

### Add a New Component

1. Create `frontend/src/components/MyComponent.tsx`
2. Define props interface if needed
3. Import and use it in a page component

---

## Troubleshooting

### "Address already in use" (port 8000)
Another process is using the port. Find and kill it:
```bash
lsof -i :8000 | grep LISTEN
kill <PID>
```

### CORS errors in browser console
The React app (port 5173) is trying to call FastAPI (port 8000) but CORS isn't allowing it. Check `api/main.py` has the correct origins in `CORSMiddleware`.

### "Module not found" errors in React
Run `npm install` in the `frontend/` directory. If a specific package is missing:
```bash
cd frontend && npm install <package-name>
```

### TypeScript errors
Run `npx tsc --noEmit` in `frontend/` to see all type errors. Common fixes:
- Add `?` to optional fields in interfaces
- Use `as` for type assertions when the compiler can't infer

### Changes not appearing
- **Python:** If `--reload` flag is used, changes should auto-apply. Otherwise restart uvicorn.
- **React:** Vite's HMR should update instantly. If not, hard-refresh (Cmd+Shift+R).

### Database locked
Both Streamlit and FastAPI share `robotaste.db`. SQLite handles concurrent reads but only one writer. If you see "database is locked", ensure only one app is writing at a time.
